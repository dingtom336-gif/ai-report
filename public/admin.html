<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - AI å‘¨æŠ¥æ¶¦è‰²</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* ç™»å½•é¡µ */
    .login-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-box {
      background: white;
      border-radius: 16px;
      padding: 40px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-box h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }

    .login-box .form-group {
      margin-bottom: 20px;
    }

    .login-box label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .login-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }

    .login-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-box button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .login-box .error {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }

    /* ä¸»ç•Œé¢ */
    .admin-page { display: none; }
    .admin-page.active { display: block; }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 20px; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-name {
      font-size: 14px;
      opacity: 0.9;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* æ ‡ç­¾é¡µ */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid #eee;
    }

    .tab {
      padding: 15px 25px;
      border: none;
      background: none;
      font-size: 14px;
      cursor: pointer;
      color: #666;
      position: relative;
    }

    .tab.active {
      color: #667eea;
      font-weight: 600;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: #667eea;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .stat-card .label {
      color: #666;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    .stat-card .sub {
      color: #999;
      font-size: 12px;
      margin-top: 5px;
    }

    /* å›¾è¡¨åŒºåŸŸ */
    .charts-section {
      padding: 0 30px 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .chart-card h3 {
      font-size: 15px;
      color: #333;
      margin-bottom: 15px;
    }

    /* ç”¨æˆ·åˆ—è¡¨ */
    .content-section {
      padding: 20px 30px;
      display: none;
    }

    .content-section.active { display: block; }

    .data-table {
      width: 100%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .data-table th,
    .data-table td {
      padding: 15px 20px;
      text-align: left;
      font-size: 14px;
    }

    .data-table th {
      background: #f8f9fa;
      color: #666;
      font-weight: 600;
    }

    .data-table tr:not(:last-child) td {
      border-bottom: 1px solid #eee;
    }

    .data-table tr:hover td {
      background: #f8f9fa;
    }

    .plan-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .plan-badge.free {
      background: #f0f0f0;
      color: #666;
    }

    .plan-badge.pro {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .role-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }

    .role-badge.admin {
      background: #e3f2fd;
      color: #1976d2;
    }

    .role-badge.user {
      background: #f5f5f5;
      color: #666;
    }

    /* åé¦ˆåˆ—è¡¨ */
    .feedback-list {
      display: grid;
      gap: 15px;
    }

    .feedback-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }

    .feedback-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .feedback-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .feedback-meta {
      display: flex;
      gap: 8px;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }

    .tag-bug { background: #ffe0e0; color: #d63031; }
    .tag-suggestion { background: #e0f0ff; color: #0984e3; }
    .tag-inquiry { background: #e8f5e9; color: #27ae60; }

    .status-pending { background: #fff3e0; color: #f39c12; }
    .status-processing { background: #e3f2fd; color: #2196f3; }
    .status-completed { background: #e8f5e9; color: #4caf50; }

    .feedback-desc {
      color: #666;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .feedback-footer {
      display: flex;
      justify-content: space-between;
      color: #999;
      font-size: 12px;
    }

    /* ç­›é€‰ */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .filters select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    /* å¼¹çª— */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 { font-size: 18px; color: #333; }

    .close-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: #f5f5f5;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }

    .modal-body { padding: 20px; }

    .detail-row { margin-bottom: 15px; }
    .detail-label { color: #999; font-size: 12px; margin-bottom: 5px; }
    .detail-value { color: #333; font-size: 14px; line-height: 1.6; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 8px; color: #555; font-size: 14px; }
    .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    /* æ“ä½œæŒ‰é’® */
    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .btn-view {
      background: #e3f2fd;
      color: #1976d2;
    }
    .btn-view:hover {
      background: #bbdefb;
    }
    .btn-upgrade {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      margin-left: 6px;
    }
    .btn-upgrade:hover {
      transform: scale(1.05);
    }
    .btn-downgrade {
      background: #f5f5f5;
      color: #666;
      margin-left: 6px;
    }
    .btn-downgrade:hover {
      background: #e0e0e0;
    }

    /* ç”¨æˆ·è¯¦æƒ… */
    .user-detail-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .user-detail-row:last-child {
      border-bottom: none;
    }
    .user-detail-label {
      width: 100px;
      color: #666;
      font-size: 13px;
    }
    .user-detail-value {
      flex: 1;
      color: #333;
      font-size: 14px;
    }
    .user-reports-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .user-reports-section h4 {
      margin-bottom: 12px;
      color: #333;
      font-size: 14px;
    }
    .user-report-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .user-report-item .meta {
      color: #999;
      font-size: 12px;
      margin-top: 6px;
    }
    .plan-switch {
      margin-top: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .plan-switch h4 {
      margin-bottom: 12px;
      font-size: 14px;
    }
    .plan-switch-btns {
      display: flex;
      gap: 10px;
    }
    .plan-switch-btns button {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .plan-switch-btns button:hover {
      border-color: #667eea;
    }
    .plan-switch-btns button.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* ç»Ÿè®¡å¡ç‰‡é«˜äº® */
    .stat-card.highlight {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .stat-card.highlight .label {
      color: rgba(255,255,255,0.8);
    }
    .stat-card.highlight .value {
      color: white;
    }
    .stat-card.highlight .sub {
      color: rgba(255,255,255,0.7);
    }

    /* Prompt ç®¡ç† */
    .prompts-grid {
      display: grid;
      gap: 20px;
    }
    .prompt-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .prompt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .prompt-header h3 {
      font-size: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .prompt-role-icon {
      font-size: 20px;
    }
    .prompt-version {
      font-size: 12px;
      color: #999;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .prompt-textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
    }
    .prompt-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .prompt-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    .btn-save-prompt {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-save-prompt:hover {
      transform: scale(1.02);
    }
    .btn-save-prompt:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-new-version {
      padding: 10px 20px;
      background: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-new-version:hover {
      background: #e0e0e0;
    }
    .prompt-history {
      margin-top: 10px;
      font-size: 12px;
      color: #999;
    }

    @media (max-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µ -->
  <div class="login-page" id="loginPage">
    <div class="login-box">
      <h1>ç®¡ç†åå°</h1>
      <form id="loginForm">
        <div class="form-group">
          <label>ç®¡ç†å‘˜é‚®ç®±</label>
          <input type="email" id="adminEmail" placeholder="admin@ai-report.com" required>
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <button type="submit">ç™»å½•</button>
        <div class="error" id="loginError"></div>
      </form>
    </div>
  </div>

  <!-- ä¸»é¡µé¢ -->
  <div class="admin-page" id="adminPage">
    <div class="header">
      <h1>ç®¡ç†åå°</h1>
      <div class="header-right">
        <span class="admin-name" id="adminName"></span>
        <button class="logout-btn" onclick="adminLogout()">é€€å‡º</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="overview">æ•°æ®æ¦‚è§ˆ</button>
      <button class="tab" data-tab="users">ç”¨æˆ·ç®¡ç†</button>
      <button class="tab" data-tab="prompts">Promptç®¡ç†</button>
      <button class="tab" data-tab="feedback">åé¦ˆç®¡ç†</button>
    </div>

    <!-- æ¦‚è§ˆ -->
    <div class="content-section active" id="overview">
      <div class="stats-grid" id="statsGrid"></div>
      <div class="stats-grid" id="enhancedStatsGrid"></div>
      <div class="charts-section">
        <div class="chart-card">
          <h3>è¿‘7å¤©ä½¿ç”¨è¶‹åŠ¿</h3>
          <canvas id="trendsChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>ç”¨æˆ·åˆ†å¸ƒ</h3>
          <canvas id="usersChart"></canvas>
        </div>
      </div>
      <div class="charts-section">
        <div class="chart-card">
          <h3>è§’è‰²ä½¿ç”¨åˆ†å¸ƒ</h3>
          <canvas id="roleChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>æ»¡æ„åº¦åˆ†å¸ƒ</h3>
          <canvas id="ratingChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç† -->
    <div class="content-section" id="users">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>æ‰‹æœº/é‚®ç®±</th>
            <th>æ˜µç§°</th>
            <th>è§’è‰²</th>
            <th>ç‰ˆæœ¬</th>
            <th>å‘¨æŠ¥æ•°</th>
            <th>æ³¨å†Œæ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- Prompt ç®¡ç† -->
    <div class="content-section" id="prompts">
      <div class="prompts-grid" id="promptsGrid">
        <div class="empty">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- åé¦ˆç®¡ç† -->
    <div class="content-section" id="feedback">
      <div class="filters">
        <select id="typeFilter" onchange="loadFeedback()">
          <option value="all">å…¨éƒ¨ç±»å‹</option>
          <option value="bug">Bug</option>
          <option value="suggestion">å»ºè®®</option>
          <option value="inquiry">å’¨è¯¢</option>
        </select>
        <select id="statusFilter" onchange="loadFeedback()">
          <option value="all">å…¨éƒ¨çŠ¶æ€</option>
          <option value="pending">å¾…å¤„ç†</option>
          <option value="processing">å¤„ç†ä¸­</option>
          <option value="completed">å·²å®Œæˆ</option>
        </select>
      </div>
      <div class="feedback-list" id="feedbackList"></div>
    </div>
  </div>

  <!-- åé¦ˆè¯¦æƒ…å¼¹çª— -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>åé¦ˆè¯¦æƒ…</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
  <div class="modal" id="userModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>ç”¨æˆ·è¯¦æƒ…</h2>
        <button class="close-btn" onclick="closeUserModal()">&times;</button>
      </div>
      <div class="modal-body" id="userModalBody"></div>
    </div>
  </div>

  <div style="position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); font-size: 11px; color: rgba(0,0,0,0.3);">v2.5.3</div>

  <script>
    const TOKEN_KEY = 'ai_report_token';
    const USER_KEY = 'ai_report_user';
    let adminToken = null;
    let adminUser = null;
    let trendsChart = null;
    let usersChart = null;
    let roleChart = null;
    let ratingChart = null;
    let usersData = [];

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkAuth() {
      const token = localStorage.getItem(TOKEN_KEY);
      const user = JSON.parse(localStorage.getItem(USER_KEY) || 'null');

      if (token && user && user.role === 'admin') {
        adminToken = token;
        adminUser = user;
        showAdminPage();
      } else {
        showLoginPage();
      }
    }

    function showLoginPage() {
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('adminPage').classList.remove('active');
    }

    function showAdminPage() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('adminPage').classList.add('active');
      document.getElementById('adminName').textContent = adminUser.email;
      loadOverview();
    }

    // ç™»å½•
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        if (data.user.role !== 'admin') {
          throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™');
        }

        localStorage.setItem(TOKEN_KEY, data.token);
        localStorage.setItem(USER_KEY, JSON.stringify(data.user));
        adminToken = data.token;
        adminUser = data.user;
        showAdminPage();
      } catch (err) {
        document.getElementById('loginError').textContent = err.message;
      }
    });

    function adminLogout() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      adminToken = null;
      adminUser = null;
      showLoginPage();
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');

        if (tab.dataset.tab === 'overview') loadOverview();
        if (tab.dataset.tab === 'users') loadUsers();
        if (tab.dataset.tab === 'prompts') loadPrompts();
        if (tab.dataset.tab === 'feedback') loadFeedback();
      });
    });

    // åŠ è½½æ¦‚è§ˆ
    async function loadOverview() {
      try {
        const [statsRes, trendsRes, enhancedRes] = await Promise.all([
          fetch('/api/admin/stats', { headers: { 'Authorization': `Bearer ${adminToken}` }}),
          fetch('/api/admin/trends?days=7', { headers: { 'Authorization': `Bearer ${adminToken}` }}),
          fetch('/api/admin/enhanced-stats', { headers: { 'Authorization': `Bearer ${adminToken}` }})
        ]);

        const stats = await statsRes.json();
        const trends = await trendsRes.json();
        const enhanced = await enhancedRes.json();

        renderStats(stats);
        renderEnhancedStats(enhanced);
        renderCharts(trends, enhanced);
      } catch (err) {
        console.error('åŠ è½½æ¦‚è§ˆå¤±è´¥:', err);
      }
    }

    function renderStats(stats) {
      const grid = document.getElementById('statsGrid');
      grid.innerHTML = `
        <div class="stat-card">
          <div class="label">æ€»ç”¨æˆ·æ•°</div>
          <div class="value">${stats.users}</div>
        </div>
        <div class="stat-card">
          <div class="label">æ€»å‘¨æŠ¥æ•°</div>
          <div class="value">${stats.reports}</div>
        </div>
        <div class="stat-card">
          <div class="label">å¾…å¤„ç†åé¦ˆ</div>
          <div class="value">${stats.feedback?.byStatus?.pending || 0}</div>
        </div>
        <div class="stat-card">
          <div class="label">æ€»åé¦ˆæ•°</div>
          <div class="value">${stats.feedback?.total || 0}</div>
        </div>
      `;
    }

    function renderEnhancedStats(enhanced) {
      const grid = document.getElementById('enhancedStatsGrid');
      const { activeUsers, todayStats, ratingStats } = enhanced;

      grid.innerHTML = `
        <div class="stat-card highlight">
          <div class="label">ä»Šæ—¥æ¶¦è‰²</div>
          <div class="value">${todayStats.polishCount}</div>
          <div class="sub">AIå¯¹è¯ ${todayStats.chatCount} æ¬¡</div>
        </div>
        <div class="stat-card">
          <div class="label">ä»Šæ—¥æ–°ç”¨æˆ·</div>
          <div class="value">${todayStats.newUsers}</div>
        </div>
        <div class="stat-card">
          <div class="label">æ´»è·ƒç”¨æˆ· (æ—¥/å‘¨/æœˆ)</div>
          <div class="value">${activeUsers.daily}</div>
          <div class="sub">${activeUsers.weekly} / ${activeUsers.monthly}</div>
        </div>
        <div class="stat-card">
          <div class="label">å¹³å‡æ»¡æ„åº¦</div>
          <div class="value">${ratingStats.averageRating || '-'}</div>
          <div class="sub">å…± ${ratingStats.totalRatings} æ¡è¯„ä»·</div>
        </div>
      `;
    }

    function renderCharts(data, enhanced) {
      // è¶‹åŠ¿å›¾
      const trendsCtx = document.getElementById('trendsChart').getContext('2d');

      if (trendsChart) trendsChart.destroy();

      const labels = data.trends.map(t => t.date.slice(5));
      const values = data.trends.map(t => t.count);

      trendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'ä½¿ç”¨æ¬¡æ•°',
            data: values,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // ç”¨æˆ·åˆ†å¸ƒå›¾
      const usersCtx = document.getElementById('usersChart').getContext('2d');

      if (usersChart) usersChart.destroy();

      const planData = data.usersByPlan || [];
      const freeCount = planData.find(p => p.plan === 'free')?.count || 0;
      const proCount = planData.find(p => p.plan === 'pro')?.count || 0;

      usersChart = new Chart(usersCtx, {
        type: 'doughnut',
        data: {
          labels: ['Free', 'Pro'],
          datasets: [{
            data: [freeCount, proCount],
            backgroundColor: ['#e0e0e0', '#667eea']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // è§’è‰²åˆ†å¸ƒå›¾
      const roleCtx = document.getElementById('roleChart').getContext('2d');
      if (roleChart) roleChart.destroy();

      const roleData = enhanced?.roleDistribution || [];
      const roleNames = { pm: 'äº§å“ç»ç†', dev: 'å¼€å‘å·¥ç¨‹å¸ˆ', ops: 'è¿è¥', custom: 'è‡ªå®šä¹‰' };
      const roleColors = { pm: '#667eea', dev: '#00c853', ops: '#ff9800', custom: '#e91e63' };

      roleChart = new Chart(roleCtx, {
        type: 'bar',
        data: {
          labels: roleData.map(r => roleNames[r.role_type] || r.role_type),
          datasets: [{
            label: 'ä½¿ç”¨æ¬¡æ•°',
            data: roleData.map(r => r.count),
            backgroundColor: roleData.map(r => roleColors[r.role_type] || '#999')
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // æ»¡æ„åº¦åˆ†å¸ƒå›¾
      const ratingCtx = document.getElementById('ratingChart').getContext('2d');
      if (ratingChart) ratingChart.destroy();

      const ratingData = enhanced?.ratingStats?.distribution || [];
      const ratingLabels = ['1æ˜Ÿ', '2æ˜Ÿ', '3æ˜Ÿ', '4æ˜Ÿ', '5æ˜Ÿ'];
      const ratingCounts = [1, 2, 3, 4, 5].map(r => {
        const found = ratingData.find(d => d.rating === r);
        return found ? found.count : 0;
      });

      ratingChart = new Chart(ratingCtx, {
        type: 'bar',
        data: {
          labels: ratingLabels,
          datasets: [{
            label: 'è¯„ä»·æ•°',
            data: ratingCounts,
            backgroundColor: ['#e53935', '#ff7043', '#ffa726', '#66bb6a', '#26a69a']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // åŠ è½½ç”¨æˆ·
    async function loadUsers() {
      try {
        const res = await fetch('/api/admin/users', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        usersData = await res.json();

        const tbody = document.getElementById('usersTable');
        tbody.innerHTML = usersData.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${u.phone || u.email || '-'}</td>
            <td>${u.nickname || '-'}</td>
            <td><span class="role-badge ${u.role}">${u.role}</span></td>
            <td><span class="plan-badge ${u.plan}">${u.plan.toUpperCase()}</span></td>
            <td>${u.report_count || 0}</td>
            <td>${formatDate(u.created_at)}</td>
            <td>
              <button class="btn-action btn-view" onclick="openUserDetail(${u.id})">è¯¦æƒ…</button>
              ${u.plan === 'free' && u.role !== 'admin'
                ? `<button class="btn-action btn-upgrade" onclick="updateUserPlan(${u.id}, 'pro')">å‡çº§Pro</button>`
                : u.plan === 'pro' && u.role !== 'admin'
                  ? `<button class="btn-action btn-downgrade" onclick="updateUserPlan(${u.id}, 'free')">é™çº§Free</button>`
                  : ''
              }
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', err);
      }
    }

    // æ‰“å¼€ç”¨æˆ·è¯¦æƒ…
    async function openUserDetail(userId) {
      try {
        const res = await fetch(`/api/admin/users/${userId}`, {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        const user = await res.json();

        const reports = user.reports || [];
        const reportsHtml = reports.length > 0
          ? reports.slice(0, 5).map(r => `
              <div class="user-report-item">
                <div>${escapeHtml(r.original_content.substring(0, 100))}${r.original_content.length > 100 ? '...' : ''}</div>
                <div class="meta">${r.role_type} Â· ${formatDate(r.created_at)}</div>
              </div>
            `).join('')
          : '<div class="empty" style="padding: 20px;">æš‚æ— å‘¨æŠ¥è®°å½•</div>';

        document.getElementById('userModalBody').innerHTML = `
          <div class="user-detail-row">
            <div class="user-detail-label">ID</div>
            <div class="user-detail-value">${user.id}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">æ‰‹æœºå·</div>
            <div class="user-detail-value">${user.phone || '-'}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">é‚®ç®±</div>
            <div class="user-detail-value">${user.email || '-'}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">æ˜µç§°</div>
            <div class="user-detail-value">${user.nickname || '-'}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">è§’è‰²</div>
            <div class="user-detail-value"><span class="role-badge ${user.role}">${user.role}</span></div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">è®¡åˆ’</div>
            <div class="user-detail-value"><span class="plan-badge ${user.plan}">${user.plan.toUpperCase()}</span></div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">ä»Šæ—¥ä½¿ç”¨</div>
            <div class="user-detail-value">${user.daily_usage || 0} æ¬¡</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">è‡ªå®šä¹‰è§’è‰²</div>
            <div class="user-detail-value">${user.customRolesCount || 0} ä¸ª</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">æ³¨å†Œæ—¶é—´</div>
            <div class="user-detail-value">${formatDate(user.created_at)}</div>
          </div>
          <div class="user-detail-row">
            <div class="user-detail-label">æœ€åç™»å½•</div>
            <div class="user-detail-value">${user.last_login ? formatDate(user.last_login) : '-'}</div>
          </div>

          ${user.role !== 'admin' ? `
          <div class="plan-switch">
            <h4>ä¿®æ”¹è®¡åˆ’</h4>
            <div class="plan-switch-btns">
              <button class="${user.plan === 'free' ? 'active' : ''}" onclick="updateUserPlan(${user.id}, 'free')">Free</button>
              <button class="${user.plan === 'pro' ? 'active' : ''}" onclick="updateUserPlan(${user.id}, 'pro')">Pro</button>
            </div>
          </div>
          ` : ''}

          <div class="user-reports-section">
            <h4>æœ€è¿‘å‘¨æŠ¥ (${reports.length})</h4>
            ${reportsHtml}
          </div>
        `;

        document.getElementById('userModal').classList.add('active');
      } catch (err) {
        console.error('åŠ è½½ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', err);
        alert('åŠ è½½å¤±è´¥');
      }
    }

    function closeUserModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    // æ›´æ–°ç”¨æˆ·è®¡åˆ’
    async function updateUserPlan(userId, plan) {
      if (!confirm(`ç¡®å®šè¦å°†æ­¤ç”¨æˆ·${plan === 'pro' ? 'å‡çº§ä¸º Pro' : 'é™çº§ä¸º Free'}ï¼Ÿ`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/users/${userId}/plan`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ plan })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        alert('æ›´æ–°æˆåŠŸ');
        loadUsers();
        closeUserModal();
      } catch (err) {
        alert('æ›´æ–°å¤±è´¥: ' + err.message);
      }
    }

    // ========== Prompt ç®¡ç† ==========
    let promptsData = [];

    async function loadPrompts() {
      try {
        const res = await fetch('/api/admin/prompts/active', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
        promptsData = await res.json();
        renderPrompts();
      } catch (err) {
        console.error('åŠ è½½ Prompts å¤±è´¥:', err);
      }
    }

    function renderPrompts() {
      const grid = document.getElementById('promptsGrid');
      const roleNames = { pm: 'äº§å“ç»ç†', dev: 'å¼€å‘å·¥ç¨‹å¸ˆ', ops: 'è¿è¥' };
      const roleIcons = { pm: 'ğŸ¯', dev: 'ğŸ’»', ops: 'ğŸ“Š' };

      if (promptsData.length === 0) {
        grid.innerHTML = '<div class="empty">æš‚æ—  Prompt æ•°æ®</div>';
        return;
      }

      grid.innerHTML = promptsData.map(p => `
        <div class="prompt-card">
          <div class="prompt-header">
            <h3>
              <span class="prompt-role-icon">${roleIcons[p.role_type] || 'ğŸ“'}</span>
              ${roleNames[p.role_type] || p.role_type}
            </h3>
            <span class="prompt-version">ç‰ˆæœ¬ ${p.version}</span>
          </div>
          <textarea class="prompt-textarea" id="prompt-${p.id}" data-original="${escapeHtml(p.content)}">${escapeHtml(p.content)}</textarea>
          <div class="prompt-actions">
            <button class="btn-new-version" onclick="createNewPromptVersion('${p.role_type}', ${p.id})">ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬</button>
            <button class="btn-save-prompt" onclick="savePrompt(${p.id})">ä¿å­˜</button>
          </div>
          <div class="prompt-history">æ›´æ–°æ—¶é—´: ${p.updated_at ? formatDate(p.updated_at) : formatDate(p.created_at)}</div>
        </div>
      `).join('');
    }

    async function savePrompt(id) {
      const textarea = document.getElementById('prompt-' + id);
      const content = textarea.value.trim();

      if (!content) {
        alert('Prompt å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
      }

      try {
        const res = await fetch('/api/admin/prompts/' + id, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ content })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        alert('ä¿å­˜æˆåŠŸ');
        loadPrompts();
      } catch (err) {
        alert('ä¿å­˜å¤±è´¥: ' + err.message);
      }
    }

    async function createNewPromptVersion(roleType, currentId) {
      const textarea = document.getElementById('prompt-' + currentId);
      const content = textarea.value.trim();

      if (!content) {
        alert('Prompt å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
      }

      if (!confirm('ç¡®å®šè¦ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬ï¼Ÿå½“å‰ç‰ˆæœ¬å°†è¢«åœç”¨ã€‚')) {
        return;
      }

      try {
        const res = await fetch('/api/admin/prompts', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ roleType, content })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        alert('æ–°ç‰ˆæœ¬åˆ›å»ºæˆåŠŸ');
        loadPrompts();
      } catch (err) {
        alert('åˆ›å»ºå¤±è´¥: ' + err.message);
      }
    }

    // åŠ è½½åé¦ˆ
    async function loadFeedback() {
      const type = document.getElementById('typeFilter').value;
      const status = document.getElementById('statusFilter').value;

      try {
        const res = await fetch(`/api/feedback?type=${type}&status=${status}`);
        const list = await res.json();

        const container = document.getElementById('feedbackList');

        if (list.length === 0) {
          container.innerHTML = '<div class="empty">æš‚æ— åé¦ˆ</div>';
          return;
        }

        const typeNames = { bug: 'Bug', suggestion: 'å»ºè®®', inquiry: 'å’¨è¯¢' };
        const statusNames = { pending: 'å¾…å¤„ç†', processing: 'å¤„ç†ä¸­', completed: 'å·²å®Œæˆ' };

        container.innerHTML = list.map(f => `
          <div class="feedback-card" onclick="openFeedback('${f.id}')">
            <div class="feedback-header">
              <div class="feedback-title">${escapeHtml(f.title)}</div>
              <div class="feedback-meta">
                <span class="tag tag-${f.type}">${typeNames[f.type] || f.type}</span>
                <span class="tag status-${f.status}">${statusNames[f.status] || f.status}</span>
              </div>
            </div>
            <div class="feedback-desc">${escapeHtml(f.description)}</div>
            <div class="feedback-footer">
              <span>${formatDate(f.created_at)}</span>
              <span>${f.contact || 'æœªç•™è”ç³»æ–¹å¼'}</span>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('åŠ è½½åé¦ˆå¤±è´¥:', err);
      }
    }

    let currentFeedback = null;

    function openFeedback(id) {
      fetch(`/api/feedback?type=all&status=all`)
        .then(res => res.json())
        .then(list => {
          const f = list.find(item => item.id === id);
          if (!f) return;

          currentFeedback = f;
          const typeNames = { bug: 'Bug', suggestion: 'å»ºè®®', inquiry: 'å’¨è¯¢' };

          document.getElementById('modalBody').innerHTML = `
            <div class="detail-row">
              <div class="detail-label">ç±»å‹</div>
              <div class="detail-value">${typeNames[f.type] || f.type}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">æ ‡é¢˜</div>
              <div class="detail-value">${escapeHtml(f.title)}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">æè¿°</div>
              <div class="detail-value">${escapeHtml(f.description)}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">è”ç³»æ–¹å¼</div>
              <div class="detail-value">${f.contact || 'æœªæä¾›'}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">æäº¤æ—¶é—´</div>
              <div class="detail-value">${formatDate(f.created_at)}</div>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            <div class="form-group">
              <label>çŠ¶æ€</label>
              <select id="updateStatus">
                <option value="pending" ${f.status === 'pending' ? 'selected' : ''}>å¾…å¤„ç†</option>
                <option value="processing" ${f.status === 'processing' ? 'selected' : ''}>å¤„ç†ä¸­</option>
                <option value="completed" ${f.status === 'completed' ? 'selected' : ''}>å·²å®Œæˆ</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¤‡æ³¨</label>
              <textarea id="updateNote" placeholder="å¤„ç†å¤‡æ³¨...">${f.note || ''}</textarea>
            </div>
            <button class="save-btn" onclick="updateFeedback()">ä¿å­˜</button>
          `;

          document.getElementById('modal').classList.add('active');
        });
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
      currentFeedback = null;
    }

    async function updateFeedback() {
      if (!currentFeedback) return;

      const status = document.getElementById('updateStatus').value;
      const note = document.getElementById('updateNote').value;

      try {
        const res = await fetch(`/api/feedback/${currentFeedback.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ status, note })
        });

        if (!res.ok) throw new Error('æ›´æ–°å¤±è´¥');

        closeModal();
        loadFeedback();
      } catch (err) {
        alert(err.message);
      }
    }

    function formatDate(str) {
      if (!str) return '-';
      const d = new Date(str);
      return d.toLocaleDateString('zh-CN') + ' ' + d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // åˆå§‹åŒ–
    checkAuth();
  </script>
</body>
</html>
