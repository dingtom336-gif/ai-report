<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统日志 - AI 周报润色</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .login-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
    }

    /* 日志页面样式 */
    .logs-container {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .header h1 {
      color: #333;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-secondary {
      padding: 8px 16px;
      background: white;
      color: #666;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: #f8f8f8;
    }

    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      color: #666;
    }

    .filters {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filters select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      min-width: 120px;
    }

    .stat-card .label {
      font-size: 12px;
      color: #666;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }

    .logs-table-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .logs-table {
      width: 100%;
      border-collapse: collapse;
    }

    .logs-table th,
    .logs-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .logs-table th {
      background: #f8f8f8;
      font-weight: 500;
      color: #666;
      font-size: 13px;
    }

    .logs-table td {
      font-size: 13px;
      color: #333;
    }

    .logs-table tr:hover {
      background: #fafafa;
    }

    .action-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .action-send_code { background: #e3f2fd; color: #1976d2; }
    .action-verify_code { background: #fff3e0; color: #f57c00; }
    .action-login { background: #e8f5e9; color: #388e3c; }
    .action-register { background: #f3e5f5; color: #7b1fa2; }
    .action-polish { background: #e0f7fa; color: #0097a7; }
    .action-chat { background: #fce4ec; color: #c2185b; }

    .metadata {
      font-family: monospace;
      font-size: 12px;
      color: #666;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .success-badge {
      color: #388e3c;
    }

    .fail-badge {
      color: #e74c3c;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    @media (max-width: 768px) {
      .logs-container {
        padding: 10px;
      }

      .header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .stats {
        flex-direction: column;
      }

      .logs-table {
        font-size: 12px;
      }

      .logs-table th,
      .logs-table td {
        padding: 8px 10px;
      }
    }
  </style>
</head>
<body>
  <!-- 登录页面 -->
  <div class="login-container" id="loginPage">
    <h1>系统日志</h1>
    <form id="loginForm">
      <div class="form-group">
        <label>管理员邮箱</label>
        <input type="email" id="email" required>
      </div>
      <div class="form-group">
        <label>密码</label>
        <input type="password" id="password" required>
      </div>
      <button type="submit" class="btn">登录</button>
      <div class="error" id="loginError"></div>
    </form>
  </div>

  <!-- 日志页面 -->
  <div class="logs-container" id="logsPage">
    <div class="header">
      <h1>系统日志</h1>
      <div class="header-actions">
        <label class="auto-refresh">
          <input type="checkbox" id="autoRefresh" checked>
          自动刷新 (30s)
        </label>
        <button class="btn-secondary" onclick="loadLogs()">刷新</button>
        <button class="btn-secondary" onclick="logout()">退出</button>
      </div>
    </div>

    <div class="stats" id="stats"></div>

    <div class="filters">
      <label>操作类型：</label>
      <select id="actionFilter" onchange="loadLogs()">
        <option value="all">全部</option>
        <option value="send_code">发送验证码</option>
        <option value="verify_code">验证验证码</option>
        <option value="login">用户登录</option>
        <option value="register">用户注册</option>
        <option value="polish">周报润色</option>
        <option value="chat">AI对话</option>
      </select>
      <label>显示条数：</label>
      <select id="limitFilter" onchange="loadLogs()">
        <option value="50">50条</option>
        <option value="100" selected>100条</option>
        <option value="200">200条</option>
        <option value="500">500条</option>
      </select>
    </div>

    <div class="logs-table-container">
      <table class="logs-table">
        <thead>
          <tr>
            <th>时间</th>
            <th>操作</th>
            <th>用户ID</th>
            <th>详情</th>
          </tr>
        </thead>
        <tbody id="logsBody">
          <tr><td colspan="4" class="loading">加载中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div style="position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); font-size: 11px; color: rgba(0,0,0,0.3);">v1.4.4</div>

  <script>
    const TOKEN_KEY = 'ai_report_token';
    const USER_KEY = 'ai_report_user';
    let refreshTimer = null;

    // 检查登录状态
    function checkAuth() {
      const token = localStorage.getItem(TOKEN_KEY);
      const user = JSON.parse(localStorage.getItem(USER_KEY) || 'null');

      if (token && user && user.role === 'admin') {
        showLogsPage();
        return true;
      }
      showLoginPage();
      return false;
    }

    function showLoginPage() {
      document.getElementById('loginPage').style.display = 'block';
      document.getElementById('logsPage').style.display = 'none';
      stopAutoRefresh();
    }

    function showLogsPage() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('logsPage').style.display = 'block';
      loadStats();
      loadLogs();
      startAutoRefresh();
    }

    // 登录
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || '登录失败');
        }

        if (data.user.role !== 'admin') {
          throw new Error('需要管理员权限');
        }

        localStorage.setItem(TOKEN_KEY, data.token);
        localStorage.setItem(USER_KEY, JSON.stringify(data.user));
        showLogsPage();
      } catch (err) {
        document.getElementById('loginError').textContent = err.message;
      }
    });

    // 退出
    function logout() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      showLoginPage();
    }

    // 获取 token
    function getToken() {
      return localStorage.getItem(TOKEN_KEY);
    }

    // 加载统计
    async function loadStats() {
      try {
        const res = await fetch('/api/admin/logs/stats', {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });

        if (!res.ok) throw new Error('加载失败');

        const data = await res.json();

        const actionLabels = {
          send_code: '发送验证码',
          verify_code: '验证验证码',
          login: '登录',
          register: '注册',
          polish: '润色',
          chat: '对话'
        };

        let html = `<div class="stat-card"><div class="label">总计</div><div class="value">${data.total}</div></div>`;

        data.byAction.forEach(item => {
          html += `<div class="stat-card"><div class="label">${actionLabels[item.action] || item.action}</div><div class="value">${item.count}</div></div>`;
        });

        document.getElementById('stats').innerHTML = html;
      } catch (err) {
        console.error('加载统计失败:', err);
      }
    }

    // 加载日志
    async function loadLogs() {
      const action = document.getElementById('actionFilter').value;
      const limit = document.getElementById('limitFilter').value;

      try {
        const url = `/api/admin/logs?action=${action}&limit=${limit}`;
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });

        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            logout();
            return;
          }
          throw new Error('加载失败');
        }

        const data = await res.json();

        const actionLabels = {
          send_code: '发送验证码',
          verify_code: '验证验证码',
          login: '登录',
          register: '注册',
          polish: '润色',
          chat: '对话'
        };

        if (data.logs.length === 0) {
          document.getElementById('logsBody').innerHTML = '<tr><td colspan="4" class="empty-state">暂无日志</td></tr>';
          return;
        }

        const html = data.logs.map(log => {
          const time = new Date(log.created_at + 'Z').toLocaleString('zh-CN');
          const actionLabel = actionLabels[log.action] || log.action;
          const metadata = formatMetadata(log.metadata);

          return `
            <tr>
              <td>${time}</td>
              <td><span class="action-badge action-${log.action}">${actionLabel}</span></td>
              <td>${log.user_id || '-'}</td>
              <td class="metadata">${metadata}</td>
            </tr>
          `;
        }).join('');

        document.getElementById('logsBody').innerHTML = html;
      } catch (err) {
        console.error('加载日志失败:', err);
        document.getElementById('logsBody').innerHTML = '<tr><td colspan="4" class="empty-state">加载失败</td></tr>';
      }
    }

    // 格式化 metadata
    function formatMetadata(metadata) {
      if (!metadata || Object.keys(metadata).length === 0) {
        return '-';
      }

      const parts = [];

      if (metadata.phone) {
        parts.push(`手机: ${metadata.phone}`);
      }

      if (metadata.success !== undefined) {
        parts.push(metadata.success
          ? '<span class="success-badge">成功</span>'
          : '<span class="fail-badge">失败</span>');
      }

      if (metadata.role) {
        parts.push(`角色: ${metadata.role}`);
      }

      if (metadata.chars) {
        parts.push(`字数: ${metadata.chars}`);
      }

      return parts.join(' | ') || JSON.stringify(metadata);
    }

    // 自动刷新
    function startAutoRefresh() {
      stopAutoRefresh();
      if (document.getElementById('autoRefresh').checked) {
        refreshTimer = setInterval(() => {
          loadLogs();
          loadStats();
        }, 30000);
      }
    }

    function stopAutoRefresh() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
    }

    document.getElementById('autoRefresh').addEventListener('change', () => {
      if (document.getElementById('autoRefresh').checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });

    // 初始化
    checkAuth();
  </script>
</body>
</html>
