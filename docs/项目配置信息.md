# AI 周报润色 - 项目配置信息

> 本文档用于理解项目技术架构和部署配置，便于给出代码改进建议。
> 最后更新：2026-02-01 v1.8.0

---

## 一、基本信息

| 项目 | 值 |
|------|-----|
| 项目名称 | ai-report |
| 本地开发路径 | /Users/xiaozhang/Desktop/claude-test/feedback-system |
| Git 仓库路径 | /Users/xiaozhang/Desktop/claude-test/ai-report |
| GitHub | https://github.com/dingtom336-gif/ai-report |
| 线上地址 | https://ai-report-production-1b54.up.railway.app/ |
| 部署平台 | Railway（GitHub 自动部署） |
| 当前版本 | v1.8.0 |

---

## 二、技术栈

| 层级 | 技术 | 版本 |
|------|------|------|
| 运行时 | Node.js | ≥18.0.0 |
| 后端框架 | Express | 4.18.2 |
| 数据库 | SQLite (better-sqlite3) | 12.6.2 |
| 认证 | JWT (jsonwebtoken) | 9.0.3 |
| 密码 | bcryptjs | 3.0.3 |
| 环境变量 | dotenv | 16.3.1 |
| 前端 | 原生 HTML/CSS/JS | - |
| AI 服务 | DeepSeek API | - |

---

## 三、文件结构

```
ai-report/
├── server.js                 # 主服务器（所有 API 路由）
├── package.json              # 依赖配置
├── .env                      # 环境变量（本地）
│
├── db/
│   ├── database.js           # 数据库初始化 + CRUD
│   └── init.js               # 初始化脚本（可选）
│
├── middleware/
│   ├── auth.js               # JWT 验证、权限检查
│   └── paywall.js            # 付费墙规则
│
├── public/
│   ├── landing.html          # 产品首页
│   ├── index.html            # 主润色页面
│   ├── login.html            # 登录页
│   ├── history.html          # 历史记录
│   ├── logs.html             # 系统日志
│   ├── admin.html            # 管理后台
│   ├── submit.html           # 反馈提交
│   └── mobile.html           # 移动端
│
├── docs/
│   ├── 项目详细功能.md        # PRD 文档
│   └── 项目配置信息.md        # 技术文档
│
└── data/
    └── app.db                # SQLite 数据库
```

---

## 四、环境变量

```env
# 必需
DEEPSEEK_API_KEY=sk_xxxxx         # DeepSeek API Key

# 可选
PORT=3000                         # 服务端口
JWT_SECRET=your-secret-key        # JWT 签名密钥
JWT_EXPIRES_IN=7d                 # JWT 有效期
DATABASE_PATH=/data/app.db        # 数据库路径（Railway）

# 管理员（自动创建）
ADMIN_EMAIL=admin@ai-report.com   # 管理员邮箱
ADMIN_PASSWORD=admin123           # 管理员密码

# 代理（开发环境）
HTTP_PROXY=http://127.0.0.1:7890  # HTTP 代理
```

---

## 五、数据库表结构

### 5.1 users（用户表）
```sql
id              INTEGER PRIMARY KEY
phone           TEXT UNIQUE          -- 手机号
email           TEXT UNIQUE          -- 邮箱（管理员）
password_hash   TEXT                 -- 密码哈希
nickname        TEXT                 -- 昵称
role            TEXT DEFAULT 'user'  -- user|admin
plan            TEXT DEFAULT 'free'  -- free|pro
daily_usage     INTEGER DEFAULT 0    -- 当日使用次数
last_usage_date TEXT                 -- 上次使用日期
created_at      TEXT                 -- 创建时间
last_login      TEXT                 -- 最后登录
```

### 5.2 verification_codes（验证码表）
```sql
id          INTEGER PRIMARY KEY
phone       TEXT NOT NULL            -- 手机号
code        TEXT NOT NULL            -- 验证码（固定 123456）
expires_at  TEXT NOT NULL            -- 过期时间（5分钟）
used        INTEGER DEFAULT 0        -- 是否已使用
created_at  TEXT                     -- 创建时间
```

### 5.3 reports（周报表）
```sql
id               INTEGER PRIMARY KEY
user_id          INTEGER              -- 用户ID
original_content TEXT                 -- 原始内容
polished_content TEXT                 -- 润色结果
role_type        TEXT                 -- pm|dev|ops
used_template    INTEGER DEFAULT 0    -- 是否用范本
created_at       TEXT                 -- 创建时间
```

### 5.4 templates（范本表）
```sql
id         INTEGER PRIMARY KEY
user_id    INTEGER                   -- 用户ID
name       TEXT                      -- 范本名称
content    TEXT                      -- 范本内容
created_at TEXT                      -- 创建时间
updated_at TEXT                      -- 更新时间
```

### 5.5 chat_history（对话历史表）
```sql
id             INTEGER PRIMARY KEY
report_id      INTEGER               -- 周报ID
user_message   TEXT                  -- 用户指令
ai_thought     TEXT                  -- AI 思考
ai_action      TEXT                  -- AI 输出
ai_observation TEXT                  -- AI 观察
created_at     TEXT                  -- 时间
```

### 5.6 usage_logs（使用日志表）
```sql
id         INTEGER PRIMARY KEY
user_id    INTEGER                   -- 用户ID（可空）
action     TEXT                      -- 操作类型
metadata   TEXT                      -- JSON 数据
created_at TEXT                      -- 时间
```

### 5.7 feedback（反馈表）
```sql
id          TEXT PRIMARY KEY         -- UUID
type        TEXT                     -- bug|feature|feedback
title       TEXT                     -- 标题
description TEXT                     -- 描述
contact     TEXT                     -- 联系方式
status      TEXT DEFAULT 'pending'   -- 状态
note        TEXT                     -- 管理员备注
created_at  TEXT                     -- 创建时间
updated_at  TEXT                     -- 更新时间
```

---

## 六、API 接口

### 6.1 认证
| 方法 | 路由 | 功能 | 认证 |
|------|------|------|------|
| POST | /api/auth/send-code | 发送验证码 | 无 |
| POST | /api/auth/login | 登录/注册 | 无 |
| GET | /api/auth/me | 获取当前用户 | JWT |

### 6.2 业务
| 方法 | 路由 | 功能 | 认证 |
|------|------|------|------|
| POST | /api/polish | 一键润色 | 可选 |
| POST | /api/chat | AI 对话修改 | JWT+Pro |
| GET | /api/reports | 周报列表 | JWT |
| GET | /api/reports/:id | 周报详情 | JWT |
| DELETE | /api/reports/:id | 删除周报 | JWT |
| GET/POST/PUT/DELETE | /api/templates | 范本 CRUD | JWT+Pro |
| GET | /api/user/stats | 用户统计 | JWT |
| POST | /api/log | 埋点日志 | 可选 |

### 6.3 反馈
| 方法 | 路由 | 功能 | 认证 |
|------|------|------|------|
| POST | /api/feedback | 提交反馈 | 无 |
| GET | /api/feedback | 查询反馈 | 无 |
| PUT | /api/feedback/:id | 更新反馈 | Admin |
| GET | /api/stats | 反馈统计 | 无 |

### 6.4 管理
| 方法 | 路由 | 功能 | 认证 |
|------|------|------|------|
| GET | /api/admin/stats | 管理统计 | Admin |
| GET | /api/admin/users | 用户列表 | Admin |
| GET | /api/admin/trends | 使用趋势 | Admin |
| GET | /api/admin/logs | 系统日志 | Admin |
| GET | /api/admin/logs/stats | 日志统计 | Admin |

---

## 七、认证机制

### 7.1 JWT Token
- 签名密钥：JWT_SECRET 环境变量
- 有效期：7 天
- 负载：{id, email, role, plan}
- 存储：客户端 localStorage

### 7.2 手机验证码
- 验证码：固定 123456（测试阶段）
- 有效期：5 分钟
- 存储：verification_codes 表
- 自动注册：验证通过后自动创建用户

### 7.3 管理员账号
- 邮箱：admin@ai-report.com（可配置）
- 密码：admin123（可配置）
- 自动创建：服务启动时检查并创建

---

## 八、第三方服务

### 8.1 DeepSeek API
- 端点：https://api.deepseek.com/v1/chat/completions
- 模型：deepseek-chat
- 认证：Bearer Token
- 用途：周报润色、AI 对话

---

## 九、部署配置

### 9.1 Railway 部署
- 部署方式：GitHub 自动部署（push 触发）
- 部署时间：2-5 分钟
- 日志查看：Railway 控制台 或 /logs.html

### 9.2 开发工作流
```bash
# 1. 在 feedback-system 目录修改代码
# 2. 同步到 ai-report
cp feedback-system/server.js ai-report/
cp feedback-system/db/*.js ai-report/db/
cp feedback-system/public/*.html ai-report/public/

# 3. 提交推送
cd ai-report
git add .
git commit -m "描述"
git push origin main

# 4. 等待 Railway 自动部署（2-5分钟）
# 5. 刷新线上页面验证版本号
```

### 9.3 本地开发
```bash
cd feedback-system
npm install
npm run dev  # 或 npm start
# 访问 http://localhost:3000
```

---

## 十、已知问题与 TODO

### 10.1 待解决
- [ ] 接入真实短信服务（验证码）
- [ ] 接入支付系统（Pro 升级）
- [ ] Railway Volume 持久化配置

### 10.2 安全问题
- GET /api/feedback 无需认证（应加权限）
- GET /api/stats 无需认证（应加权限）
- 验证码固定 123456（测试阶段）

### 10.3 性能优化
- index.html 单文件 3000+ 行（应拆分）
- 无 CDN 加速
- 无缓存策略

---

## 十一、关键文件说明

| 文件 | 说明 |
|------|------|
| server.js | 所有 API 路由、AI 调用逻辑 |
| db/database.js | 数据库初始化、所有表 CRUD |
| middleware/auth.js | JWT 验证、密码加密、权限检查 |
| middleware/paywall.js | 付费墙规则、功能权限控制 |
| public/index.html | 主润色页面（核心功能） |
| public/login.html | 登录页（手机验证码） |
| public/admin.html | 管理后台（Chart.js） |
| public/logs.html | 系统日志查看 |

---

## 十二、访问地址

### 12.1 线上环境（Railway）

| 页面 | URL |
|------|-----|
| 产品首页 | https://ai-report-production-1b54.up.railway.app/landing.html |
| 主润色页面 | https://ai-report-production-1b54.up.railway.app/index.html |
| 登录页 | https://ai-report-production-1b54.up.railway.app/login.html |
| 周报历史 | https://ai-report-production-1b54.up.railway.app/history.html |
| 反馈提交 | https://ai-report-production-1b54.up.railway.app/submit.html |
| 系统日志 | https://ai-report-production-1b54.up.railway.app/logs.html |
| 管理后台 | https://ai-report-production-1b54.up.railway.app/admin.html |

### 12.2 API 基础地址

| 环境 | 地址 |
|------|------|
| 线上 | https://ai-report-production-1b54.up.railway.app/api |
| 本地 | http://localhost:3000/api |

### 12.3 外部服务

| 服务 | 地址 |
|------|------|
| GitHub 仓库 | https://github.com/dingtom336-gif/ai-report |
| Railway 控制台 | https://railway.com/project/d850dd65-b337-4ad1-b273-1ff41bd085fe |
| DeepSeek API | https://api.deepseek.com/v1/chat/completions |

---

## 十三、账号信息

### 13.1 管理员账号

| 项目 | 值 |
|------|-----|
| 邮箱 | admin@ai-report.com |
| 密码 | admin123 |
| 权限 | 管理员（可访问后台、日志） |
| 登录入口 | /admin.html 或 /logs.html |

### 13.2 测试用户账号

| 类型 | 登录方式 | 说明 |
|------|---------|------|
| 任意手机号 | 手机号 + 验证码 123456 | 自动注册为 Free 用户 |

### 13.3 API 密钥

| 服务 | 环境变量 | 说明 |
|------|---------|------|
| DeepSeek | DEEPSEEK_API_KEY | AI 润色服务 |
| JWT | JWT_SECRET | Token 签名密钥 |

### 13.4 验证码（测试阶段）

| 项目 | 值 |
|------|-----|
| 固定验证码 | 123456 |
| 有效期 | 5 分钟 |
| 适用范围 | 所有手机号 |
